<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Investment Simulator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f0f0f0;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            margin: auto;
        }
        input[type="text"], input[type="number"] {
            width: calc(100% - 20px);
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background-color: #28a745;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
        }
        button:hover {
            background-color: #218838;
        }
        .suggestions {
            margin-top: 10px;
            border: 1px solid #ccc;
            max-height: 150px;
            overflow-y: auto;
        }
        .suggestion-item {
            padding: 5px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f0f0f0;
        }
        .stock-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .earnings {
            margin-top: 20px;
            font-weight: bold;
        }
        #chartContainer {
            margin-top: 20px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h2>Investment Simulator</h2>
        <p>Budget: $<span id="budget">10000</span></p>
        <input type="text" id="symbol" placeholder="Search stock symbol..." oninput="filterSymbols()">
        <div class="suggestions" id="suggestions"></div>
        <input type="number" id="amount" placeholder="Enter amount to invest ($)" min="1">
        <button onclick="simulateInvestment()">Buy Stock</button>
        <div class="result" id="result"></div>

        <h3>My Stocks</h3>
        <div class="my-stocks" id="myStocks"></div>
        
        <div class="earnings" id="earnings"></div>
        
        <div id="chartContainer">
            <canvas id="priceChart"></canvas>
        </div>
    </div>

    <script>
        const ALPHA_VANTAGE_API_KEY = 'QB54E92J3E8N4GKX'; // Your Alpha Vantage API key
        const FINNHUB_API_KEY = 'crvr62hr01qkji45on7gcrvr62hr01qkji45on80'; // Your Finnhub API key

        let stockList = [];
        let budget = 10000;
        let userStocks = {}; // To track user's stocks
        let selectedStockSymbol = ""; // To track the selected stock

        // Fetch stock symbols on page load
        async function fetchStockSymbols() {
            const url = `https://finnhub.io/api/v1/stock/symbol?exchange=US&token=${FINNHUB_API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            stockList = data;
        }

        async function getStockPrice(symbol) {
            const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`;
            const response = await fetch(url);
            const data = await response.json();
            if (data['Global Quote'] && data['Global Quote']['05. price']) {
                return parseFloat(data['Global Quote']['05. price']);
            } else {
                throw new Error("Error fetching data. Please check the stock symbol.");
            }
        }

        async function getHistoricalData(symbol) {
            const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}&outputsize=compact`;
            const response = await fetch(url);
            const data = await response.json();
            const timeSeries = data['Time Series (Daily)'];
            if (!timeSeries) throw new Error("No historical data available.");
            const labels = [];
            const prices = [];
            const days = Object.keys(timeSeries).slice(0, 10); // Get last 10 days
            for (const day of days) {
                labels.push(day);
                prices.push(parseFloat(timeSeries[day]['4. close']));
            }
            return { labels, prices };
        }

        function filterSymbols() {
            const input = document.getElementById('symbol').value.toUpperCase();
            const suggestionsDiv = document.getElementById('suggestions');
            suggestionsDiv.innerHTML = '';

            if (input) {
                const filteredStocks = stockList.filter(stock => 
                    stock.symbol.toUpperCase().startsWith(input) || stock.description.toUpperCase().startsWith(input)
                );

                filteredStocks.forEach(stock => {
                    const div = document.createElement('div');
                    div.textContent = `${stock.symbol} - ${stock.description}`;
                    div.className = 'suggestion-item';
                    div.onclick = async () => {
                        document.getElementById('symbol').value = stock.symbol;
                        suggestionsDiv.innerHTML = ''; // Clear suggestions
                        selectedStockSymbol = stock.symbol;
                        const price = await getStockPrice(selectedStockSymbol);
                        displayCurrentPrice(price);
                        updateChart(selectedStockSymbol);
                    };
                    suggestionsDiv.appendChild(div);
                });
                
                // If there's exactly one suggestion, automatically select it
                if (filteredStocks.length === 1) {
                    const stock = filteredStocks[0];
                    document.getElementById('symbol').value = stock.symbol;
                    suggestionsDiv.innerHTML = ''; // Clear suggestions
                    selectedStockSymbol = stock.symbol;
                    updateStockInfo(selectedStockSymbol);
                }
            }
        }

        async function updateStockInfo(symbol) {
            try {
                const price = await getStockPrice(symbol);
                displayCurrentPrice(price);
                updateChart(symbol);
            } catch (error) {
                alert(error.message);
            }
        }

        async function simulateInvestment() {
            const symbol = document.getElementById('symbol').value.toUpperCase();
            const amount = parseFloat(document.getElementById('amount').value);
            const resultDiv = document.getElementById('result');

            if (!symbol || isNaN(amount) || amount <= 0) {
                resultDiv.innerHTML = `<p style="color: red;">Please enter a valid stock symbol and amount.</p>`;
                return;
            }

            try {
                const price = await getStockPrice(symbol);
                if (amount > budget) {
                    resultDiv.innerHTML = `<p style="color: red;">You don't have enough budget to invest this amount.</p>`;
                    return;
                }
                
                const shares = Math.floor(amount / price);
                budget -= shares * price; // Deduct the cost from the budget
                resultDiv.innerHTML = `
                    <h3>Results:</h3>
                    <p>You bought <strong>${shares}</strong> shares of <strong>${symbol}</strong> at $<strong>${price.toFixed(2)}</strong> each.</p>
                    <p>Total investment: $<strong>${(shares * price).toFixed(2)}</strong></p>
                `;

                // Update user stocks
                if (userStocks[symbol]) {
                    userStocks[symbol].shares += shares;
                } else {
                    userStocks[symbol] = { shares, price };
                }
                
                updateMyStocks();
                updateEarnings();
                updateBudgetDisplay();
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">${error.message}</p>`;
            }
        }

        function displayCurrentPrice(price) {
            const priceDiv = document.getElementById('result');
            priceDiv.innerHTML += `<p>Current Price of ${selectedStockSymbol}: $<strong>${price.toFixed(2)}</strong></p>`;
        }

        async function updateChart(symbol) {
            const chartContainer = document.getElementById('priceChart');
            const { labels, prices } = await getHistoricalData(symbol);

            const ctx = chartContainer.getContext('2d');
            if (window.myChart) {
                window.myChart.destroy();
            }
            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.reverse(),
                    datasets: [{
                        label: `${symbol} Price`,
                        data: prices.reverse(),
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 2,
                        fill: false,
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function updateMyStocks() {
            const myStocksDiv = document.getElementById('myStocks');
            myStocksDiv.innerHTML = '';
            for (const symbol in userStocks) {
                const stock = userStocks[symbol];
                const stockDiv = document.createElement('div');
                stockDiv.className = 'stock-item';
                stockDiv.innerHTML = `${symbol}: ${stock.shares} shares`;
                myStocksDiv.appendChild(stockDiv);
            }
        }

        function updateEarnings() {
            const earningsDiv = document.getElementById('earnings');
            let totalEarnings = 0;
            for (const symbol in userStocks) {
                const stock = userStocks[symbol];
                totalEarnings += stock.shares * stock.price; // Calculate earnings
            }
            earningsDiv.innerHTML = `Total Earnings: $${totalEarnings.toFixed(2)}`;
        }

        function updateBudgetDisplay() {
            document.getElementById('budget').innerText = budget.toFixed(2);
        }

        window.onload = fetchStockSymbols;
    </script>
</body>
</html>
